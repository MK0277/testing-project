<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>College Project Applications</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f8f9fa;
      padding: 20px;
    }

    .table-responsive {
      margin-top: 20px;
    }
  </style>
</head>

<body>

  <div class="text-center my-4">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#applyProjectModal">Apply for
      Project</button>
  </div>

  <!-- === Your Modal (paste kept exactly as you provided) === -->
  <!-- (Start modal) -->
  <div class="modal fade" id="applyProjectModal" tabindex="-1" aria-labelledby="applyProjectModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="applyProjectModalLabel">Apply for a College Project</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="projectForm" class="needs-validation" novalidate>
            <!-- Name & Email -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="fullname" class="form-label">Full Name</label>
                <input type="text" name="full_name" id="fullname" class="form-control" placeholder="Enter Name"
                  required>
              </div>
              <div class="col-md-6">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" placeholder="Enter email" required>
              </div>
            </div>

            <!-- Phone & College -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="phone" class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="phone" name="mobileno" placeholder="10-digit phone number"
                  pattern="[0-9]{10}" maxlength="10" required
                  oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10);">
              </div>
              <div class="col-md-6">
                <label for="college" class="form-label">College Name</label>
                <input type="text" class="form-control" id="college" name="college" placeholder="Enter college name"
                  required>
              </div>
            </div>

            <!-- Course -->
            <div class="mb-3">
              <label for="course" class="form-label">Course / Branch</label>
              <input type="text" class="form-control" id="course" name="course" placeholder="e.g., B.Tech - CSE"
                required>
            </div>

            <!-- Domain -->
            <div class="mb-3">
              <label for="domain" class="form-label">Project Domain</label>
              <select class="form-select" id="domain" name="domain" required>
                <option value="">Choose...</option>
                <option value="ai">Artificial Intelligence & ML</option>
                <option value="data">Data Science & Big Data</option>
                <option value="web">Web & Mobile Development</option>
                <option value="cyber">Cybersecurity & Blockchain</option>
                <option value="iot">Internet of Things (IoT)</option>
                <option value="cloud">Cloud Computing & Distributed Systems</option>
                <option value="arvr">AR, VR & Robotics</option>
              </select>
            </div>

            <!-- Sub-Domain -->
            <div class="mb-3 d-none" id="subDomainSection">
              <label for="subDomain" class="form-label">Sub-Domain</label>
              <select class="form-select" id="subDomain" name="subDomain" required>
                <option value="">Choose sub-domain...</option>
              </select>
            </div>

            <!-- Project -->
            <div class="mb-3 d-none" id="projectSection">
              <label for="projectTitle" class="form-label">Project</label>
              <select class="form-select" id="projectTitle" name="projectTitle" required>
                <option value="">Choose project...</option>
              </select>
            </div>

            <div class="text-center">
              <button type="submit" class="btn btn-primary px-4">Submit Application</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- (End modal) -->

  <!-- Table -->
  <div class="container">
    <h4 class="text-center mb-3">Submitted Applications</h4>
    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle" id="applicationsTable">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Email</th>
            <th>Mobile</th>
            <th>College</th>
            <th>Course</th>
            <th>Domain</th>
            <th>Sub Domain</th>
            <th>Project</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ---- CONFIG ----
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxel1CrzLJlQgCyxVRA0er1fh2SRaepMqVykgbgMaRMEaSMLz8dPzlORMW2x3zSoDPX/exec"; // ‚Üê replace with your deployed web app URL

    // ---- Domain/Subdomain/Project options (kept same as yours) ----
    const projectOptions = {
      ai: {
        "Machine Learning": ["Fake News Detection", "Game Agent AI"],
        "Computer Vision": ["Emotion Recognition", "Healthcare Chatbot"]
      },
      data: {
        "Analytics": ["Customer Sentiment", "Climate Modeling"],
        "Prediction": ["Stock Market Prediction", "E-Learning Dropout"]
      },
      web: {
        "E-Commerce": ["Shopping Platform"],
        "Healthcare": ["Appointment Booking", "Online Exam Proctor"]
      },
      cyber: {
        "Blockchain": ["Supply Chain Tracking", "Secure Identity Verification"],
        "Security": ["Phishing Detection", "Intrusion Detection"]
      },
      iot: {
        "Smart Home": ["IoT-Based Smart Home Automation"],
        "Smart Cities": ["Smart Waste Management System", "IoT for Traffic Control"],
        "Agriculture": ["IoT for Precision Agriculture"],
        "Healthcare": ["Wearable Health Monitoring Device"]
      },
      cloud: {
        "Cloud Applications": ["Serverless Cloud Application"],
        "Infrastructure": ["Load Balancing in Cloud Data Centers", "Cloud Disaster Recovery"],
        "Security": ["Cloud Security using Homomorphic Encryption"],
        "Optimization": ["AI for Cloud Resource Optimization"]
      },
      arvr: {
        "Education & Training": ["AR-Based Educational Learning App", "VR-Based Emergency Response Training"],
        "Healthcare": ["VR Therapy for Anxiety Disorders"],
        "Robotics & Vision": ["Robotic Arm with Computer Vision"],
        "Navigation": ["AR for Museum Navigation"]
      }
    };

    // ---- helpers ----
    function $(id) { return document.getElementById(id); }

    // ---- init modal domain/subdomain/project UI ----
    function initCollegeProjectModal() {
      const domainSelect = $("domain");
      const subDomainSelect = $("subDomain");
      const projectSelect = $("projectTitle");
      const subDomainSection = $("subDomainSection");
      const projectSection = $("projectSection");

      function resetSubProject() {
        subDomainSelect.innerHTML = '<option value="">Choose sub-domain...</option>';
        projectSelect.innerHTML = '<option value="">Choose project...</option>';
        subDomainSection.classList.add("d-none");
        projectSection.classList.add("d-none");
        subDomainSelect.required = false;
        projectSelect.required = false;
      }

      domainSelect.addEventListener("change", function () {
        const domain = this.value;
        resetSubProject();
        if (domain && projectOptions[domain]) {
          Object.keys(projectOptions[domain]).forEach(sub => {
            const opt = document.createElement("option");
            opt.value = sub;
            opt.textContent = sub;
            subDomainSelect.appendChild(opt);
          });
          subDomainSection.classList.remove("d-none");
          subDomainSelect.required = true;
        }
      });

      subDomainSelect.addEventListener("change", function () {
        const domain = domainSelect.value;
        const sub = this.value;
        projectSelect.innerHTML = '<option value="">Choose project...</option>';
        if (domain && sub && projectOptions[domain][sub]) {
          projectOptions[domain][sub].forEach(p => {
            const opt = document.createElement("option");
            opt.value = p;
            opt.textContent = p;
            projectSelect.appendChild(opt);
          });
          projectSection.classList.remove("d-none");
          projectSelect.required = true;
        } else {
          projectSection.classList.add("d-none");
          projectSelect.required = false;
        }
      });

      const applyModalEl = document.getElementById("applyProjectModal");
      applyModalEl.addEventListener('show.bs.modal', function () {
        resetSubProject();
        domainSelect.value = "";
      });
    }

    // ---- form submit (action=add) ----
    function initProjectForm() {
      const form = $("projectForm");
      if (!form) return;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // basic validation: check required
        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          return;
        }

        const body = new URLSearchParams(new FormData(form));
        body.append("action", "add");

        try {
          const res = await fetch(SCRIPT_URL, { method: "POST", body });
          const text = await res.text();
          if (text.trim() === "Added") {
            Swal.fire({ icon: "success", title: "Submitted!", text: "Application saved successfully!", timer: 1600, showConfirmButton: false });
            form.reset();
            // close modal
            const modalEl = document.getElementById("applyProjectModal");
            const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modalInstance.hide();
            loadApplications();
          } else {
            Swal.fire("Error", `Server: ${text}`, "error");
          }
        } catch (err) {
          console.error("Submit error:", err);
          Swal.fire("Error", "Submission failed. Check console/network.", "error");
        }
      });
    }

    // ---- load table from sheet ----
    async function loadApplications() {
      try {
        const res = await fetch(SCRIPT_URL);
        const data = await res.json();
        const tbody = $("tableBody");
        tbody.innerHTML = "";

        data.forEach((row, i) => {
          const status = row["Status"] || "Pending";
          const badgeClass = status === "Approved" ? "success" : (status === "Declined" ? "danger" : "warning");
          const domainText = row["Domain"] || row["domain"] || "";
          const subDomainText = row["Sub Domain"] || row["subDomain"] || "";
          const projectText = row["Project"] || row["projectTitle"] || "";

          tbody.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${i + 1}</td>
              <td>${row["Full Name"] || ""}</td>
              <td>${row["Email"] || ""}</td>
              <td>${row["Mobile"] || ""}</td>
              <td>${row["College"] || ""}</td>
              <td>${row["Course"] || ""}</td>
              <td>${domainText}</td>
              <td>${subDomainText}</td>
              <td>${projectText}</td>
              <td><span class="badge bg-${badgeClass}">${status}</span></td>
              <td>
                <button class="btn btn-success btn-sm" onclick="updateStatus(${row.index}, 'Approved')">Approve</button>
                <button class="btn btn-danger btn-sm" onclick="updateStatus(${row.index}, 'Declined')">Decline</button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteRow(${row.index})">Delete</button>
              </td>
            </tr>
          `);
        });
      } catch (err) {
        console.error("loadApplications error:", err);
        Swal.fire("Error", "Failed to load table. See console/network.", "error");
      }
    }

    // ---- update status via POST (action=update) ----
    async function updateStatus(index, status) {
      try {
        const body = new URLSearchParams({ action: "update", index, status });
        const res = await fetch(SCRIPT_URL, { method: "POST", body });
        const text = await res.text();
        if (text.trim() === "Updated") {
          Swal.fire({ icon: "success", title: "Updated", text: `Status set to ${status}`, timer: 1200, showConfirmButton: false });
        } else {
          Swal.fire("Error", `Server: ${text}`, "error");
        }
      } catch (err) {
        console.error("updateStatus error:", err);
        Swal.fire("Error", "Update failed.", "error");
      } finally {
        loadApplications();
      }
    }

    // ---- delete via POST (action=delete) ----
    async function deleteRow(index) {
      const confirm = await Swal.fire({
        title: "Are you sure?",
        text: "This record will be deleted!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete it!"
      });
      if (!confirm.isConfirmed) return;

      try {
        const body = new URLSearchParams({ action: "delete", index });
        const res = await fetch(SCRIPT_URL, { method: "POST", body });
        const text = await res.text();
        if (text.trim() === "Deleted") {
          Swal.fire({ icon: "success", title: "Deleted", timer: 1000, showConfirmButton: false });
        } else {
          Swal.fire("Error", `Server: ${text}`, "error");
        }
      } catch (err) {
        console.error("deleteRow error:", err);
        Swal.fire("Error", "Delete failed.", "error");
      } finally {
        loadApplications();
      }
    }

    // ---- init on DOMContentLoaded ----
    document.addEventListener("DOMContentLoaded", () => {
      initCollegeProjectModal();
      initProjectForm();
      loadApplications();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>